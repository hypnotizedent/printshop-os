openapi: 3.0.3
info:
  title: Production Dashboard API
  description: |
    WebSocket + REST API for real-time production updates in PrintShop OS.
    
    ## WebSocket Connection
    Connect to the WebSocket server at `ws://localhost:3000` for real-time updates.
    
    ### Events (Server → Client)
    - `employee:clocked-in` - Employee clock in notification
    - `employee:clocked-out` - Employee clock out notification
    - `timer:update` - Timer state update
    - `timer:pause` - Timer paused notification
    - `timer:resume` - Timer resumed notification
    - `order:status_changed` - Order status change notification
    - `queue:updated` - Production queue updated
    
    ### Events (Client → Server)
    - `subscribe:queue` - Subscribe to queue updates
    - `subscribe:order:{id}` - Subscribe to specific order updates
    - `unsubscribe:queue` - Unsubscribe from queue updates
    
    ## Authentication
    Most endpoints require JWT authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```
    
    For WebSocket connections, include the token in the connection handshake:
    ```javascript
    const socket = io('ws://localhost:3000', {
      auth: { token: 'your_jwt_token' }
    });
    ```
    
    ## Role-Based Access
    - **operator**: Basic access to queue and own time clock
    - **supervisor**: Queue reordering, resource allocation, employee management
    - **admin**: Full access including system configuration
  version: 1.0.0
  contact:
    name: PrintShop OS Team
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Development server
  - url: http://docker-host:3000
    description: Docker host server
  - url: ws://localhost:3000
    description: WebSocket server

tags:
  - name: Health
    description: Health check and status endpoints
  - name: Queue
    description: Production queue management
  - name: Resources
    description: Machine and employee resource tracking
  - name: Orders
    description: Order management
  - name: Time Clock
    description: Employee time tracking and management
  - name: SOPs
    description: Standard Operating Procedures
  - name: Analytics
    description: Production KPIs and metrics
  - name: Admin
    description: Administrative endpoints

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        role:
          type: string
          enum: [operator, supervisor, admin]
        email:
          type: string

    Order:
      type: object
      properties:
        id:
          type: string
        jobId:
          type: string
        customerId:
          type: string
        customerName:
          type: string
        status:
          type: string
          enum: [pending_approval, approved, in_screen, in_printing, in_curing, in_quality_check, completed, on_hold, cancelled]
        priority:
          type: integer
        service:
          type: string
          enum: [screen, dtg, embroidery]
        quantity:
          type: integer
        dueDate:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    QueueItem:
      type: object
      properties:
        order:
          $ref: '#/components/schemas/Order'
        position:
          type: integer
        estimatedStartTime:
          type: string
          format: date-time
        blockers:
          type: array
          items:
            type: string

    Machine:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [screen_press, dtg_printer, embroidery_machine, curing_station]
        status:
          type: string
          enum: [idle, running, down, maintenance]
        currentJobId:
          type: string
        utilizationPercent:
          type: number
        lastMaintenance:
          type: string
          format: date-time
        uptime:
          type: number

    Employee:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [clocked_in, clocked_out, break]
        currentJobId:
          type: string
        clockedInAt:
          type: string
          format: date-time
        productivity:
          type: number
        skillSet:
          type: array
          items:
            type: string

    Analytics:
      type: object
      properties:
        throughput:
          type: object
        cycleTime:
          type: object
        utilization:
          type: object
        bottlenecks:
          type: array
          items:
            type: object
        quality:
          type: object

    SOP:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
          description: Markdown content
        category:
          type: string
        department:
          type: string
        tags:
          type: array
          items:
            type: string
        version:
          type: integer
        active:
          type: boolean
        viewCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        createdBy:
          type: string

    RESTResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
        error:
          type: string
        timestamp:
          type: string
          format: date-time

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the API server is running
      security: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string
                  connections:
                    type: integer
                  redis:
                    type: boolean

  /api/docs:
    get:
      tags:
        - Health
      summary: API documentation
      description: Get API documentation with all available endpoints
      security: []
      responses:
        '200':
          description: API documentation
          content:
            application/json:
              schema:
                type: object

  /api/production/queue:
    get:
      tags:
        - Queue
      summary: Get production queue
      description: Retrieve the current production queue with all orders
      responses:
        '200':
          description: Production queue
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/QueueItem'

  /api/production/queue/reorder:
    post:
      tags:
        - Queue
      summary: Reorder production queue
      description: Reorder the production queue (supervisor and admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                orderIds:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Queue reordered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'
        '403':
          description: Insufficient permissions

  /api/production/queue/{orderId}:
    get:
      tags:
        - Queue
      summary: Get order in queue
      description: Get a specific order from the production queue
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/QueueItem'
        '404':
          description: Order not found

  /api/production/resources:
    get:
      tags:
        - Resources
      summary: Get all resources
      description: Get all machines and employees
      responses:
        '200':
          description: All resources
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          machines:
                            type: array
                            items:
                              $ref: '#/components/schemas/Machine'
                          employees:
                            type: array
                            items:
                              $ref: '#/components/schemas/Employee'

  /api/production/resources/machines:
    get:
      tags:
        - Resources
      summary: Get all machines
      description: Get list of all production machines
      responses:
        '200':
          description: List of machines
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Machine'

  /api/production/resources/machines/{machineId}:
    get:
      tags:
        - Resources
      summary: Get specific machine
      description: Get details of a specific machine
      parameters:
        - name: machineId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Machine details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Machine'
        '404':
          description: Machine not found

  /api/production/resources/machines/{machineId}/allocate:
    post:
      tags:
        - Resources
      summary: Allocate machine to order
      description: Allocate a machine to a specific order (supervisor and admin only)
      parameters:
        - name: machineId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                orderId:
                  type: string
      responses:
        '200':
          description: Machine allocated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Machine'
        '403':
          description: Insufficient permissions

  /api/production/resources/employees:
    get:
      tags:
        - Resources
      summary: Get all employees
      description: Get list of all employees
      responses:
        '200':
          description: List of employees
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Employee'

  /api/production/resources/employees/{employeeId}:
    get:
      tags:
        - Resources
      summary: Get specific employee
      description: Get details of a specific employee
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Employee details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Employee'
        '404':
          description: Employee not found

  /api/production/resources/employees/{employeeId}/assign:
    post:
      tags:
        - Resources
      summary: Assign employee to order
      description: Assign an employee to a specific order (supervisor and admin only)
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                orderId:
                  type: string
      responses:
        '200':
          description: Employee assigned
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Employee'
        '403':
          description: Insufficient permissions

  /api/production/orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order details
      description: Get detailed information about a specific order
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '404':
          description: Order not found

  /api/production/status:
    post:
      tags:
        - Orders
      summary: Update order status
      description: Update the status of an order
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                orderId:
                  type: string
                status:
                  type: string
                  enum: [pending_approval, approved, in_screen, in_printing, in_curing, in_quality_check, completed, on_hold, cancelled]
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '403':
          description: Insufficient permissions

  /api/production/analytics:
    get:
      tags:
        - Analytics
      summary: Get all analytics
      description: Get comprehensive production analytics and KPIs
      responses:
        '200':
          description: Analytics data
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Analytics'

  /api/production/analytics/throughput:
    get:
      tags:
        - Analytics
      summary: Get throughput metrics
      description: Get production throughput metrics
      responses:
        '200':
          description: Throughput metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'

  /api/production/analytics/cycle-time:
    get:
      tags:
        - Analytics
      summary: Get cycle time metrics
      description: Get average cycle time per stage
      responses:
        '200':
          description: Cycle time metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'

  /api/production/analytics/utilization:
    get:
      tags:
        - Analytics
      summary: Get utilization metrics
      description: Get resource utilization metrics
      responses:
        '200':
          description: Utilization metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'

  /api/production/analytics/bottlenecks:
    get:
      tags:
        - Analytics
      summary: Get bottleneck analysis
      description: Get production bottleneck analysis
      responses:
        '200':
          description: Bottleneck analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'

  /api/production/analytics/quality:
    get:
      tags:
        - Analytics
      summary: Get quality metrics
      description: Get production quality metrics
      responses:
        '200':
          description: Quality metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RESTResponse'

  /api/production/connections:
    get:
      tags:
        - Admin
      summary: Get connected users
      description: Get list of currently connected users (admin only)
      responses:
        '200':
          description: Connected users
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          count:
                            type: integer
                          users:
                            type: array
                            items:
                              $ref: '#/components/schemas/User'
        '403':
          description: Insufficient permissions

  # Time Clock endpoints
  /api/production/time-clock/in:
    post:
      tags:
        - Time Clock
      summary: Clock in
      description: Clock in an employee to start tracking time
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employeeId
                - pin
              properties:
                employeeId:
                  type: string
                pin:
                  type: string
                  pattern: "^[0-9]{4}$"
                jobId:
                  type: string
                  description: Optional job to associate with time entry
      responses:
        '200':
          description: Clocked in successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          entryId:
                            type: string
                          clockInTime:
                            type: string
                            format: date-time
                          employee:
                            $ref: '#/components/schemas/Employee'
        '401':
          description: Invalid PIN
        '409':
          description: Already clocked in

  /api/production/time-clock/out:
    post:
      tags:
        - Time Clock
      summary: Clock out
      description: Clock out an employee to stop tracking time
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employeeId
                - pin
              properties:
                employeeId:
                  type: string
                pin:
                  type: string
                  pattern: "^[0-9]{4}$"
                notes:
                  type: string
      responses:
        '200':
          description: Clocked out successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          entryId:
                            type: string
                          clockInTime:
                            type: string
                            format: date-time
                          clockOutTime:
                            type: string
                            format: date-time
                          duration:
                            type: integer
                            description: Duration in minutes
        '400':
          description: Not clocked in

  /api/production/time-clock/pause:
    post:
      tags:
        - Time Clock
      summary: Pause time tracking
      description: Pause the current time entry (for breaks)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employeeId
              properties:
                employeeId:
                  type: string
                reason:
                  type: string
      responses:
        '200':
          description: Timer paused

  /api/production/time-clock/resume:
    post:
      tags:
        - Time Clock
      summary: Resume time tracking
      description: Resume a paused time entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employeeId
              properties:
                employeeId:
                  type: string
      responses:
        '200':
          description: Timer resumed

  /api/production/time-clock/active:
    get:
      tags:
        - Time Clock
      summary: Get active clock entries
      description: Get all currently active (clocked in) employees
      responses:
        '200':
          description: Active entries
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            entryId:
                              type: string
                            employee:
                              $ref: '#/components/schemas/Employee'
                            clockInTime:
                              type: string
                              format: date-time
                            currentDuration:
                              type: integer
                            isPaused:
                              type: boolean
                            currentJob:
                              type: string

  /api/production/time-entries:
    get:
      tags:
        - Time Clock
      summary: Get time entries
      description: Get time entries with optional filtering
      parameters:
        - name: employeeId
          in: query
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: jobId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Time entries
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            employee:
                              $ref: '#/components/schemas/Employee'
                            clockIn:
                              type: string
                              format: date-time
                            clockOut:
                              type: string
                              format: date-time
                            duration:
                              type: integer
                            jobId:
                              type: string
                            notes:
                              type: string
                            approved:
                              type: boolean

    post:
      tags:
        - Time Clock
      summary: Create time entry (manual)
      description: Manually create a time entry (supervisor/admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - employeeId
                - clockIn
                - clockOut
              properties:
                employeeId:
                  type: string
                clockIn:
                  type: string
                  format: date-time
                clockOut:
                  type: string
                  format: date-time
                jobId:
                  type: string
                notes:
                  type: string
      responses:
        '201':
          description: Entry created
        '403':
          description: Insufficient permissions

  /api/production/time-entries/{id}:
    patch:
      tags:
        - Time Clock
      summary: Edit time entry
      description: Edit a time entry (requires supervisor approval if not own entry)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                clockIn:
                  type: string
                  format: date-time
                clockOut:
                  type: string
                  format: date-time
                notes:
                  type: string
      responses:
        '200':
          description: Entry updated (may require approval)
        '404':
          description: Entry not found

  /api/production/time-entries/{id}/approve:
    post:
      tags:
        - Time Clock
      summary: Approve time entry edit
      description: Approve a pending time entry edit (supervisor/admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - approved
              properties:
                approved:
                  type: boolean
                notes:
                  type: string
      responses:
        '200':
          description: Edit processed
        '403':
          description: Insufficient permissions

  /api/production/employees/{id}/time:
    get:
      tags:
        - Time Clock
      summary: Get employee time summary
      description: Get time tracking summary for an employee
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: week
      responses:
        '200':
          description: Employee time summary
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          totalHours:
                            type: number
                          regularHours:
                            type: number
                          overtimeHours:
                            type: number
                          entries:
                            type: array
                            items:
                              type: object

  # SOP endpoints
  /api/production/sops:
    get:
      tags:
        - SOPs
      summary: List SOPs
      description: Get list of Standard Operating Procedures
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: department
          in: query
          schema:
            type: string
        - name: active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: SOP list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/SOP'

    post:
      tags:
        - SOPs
      summary: Create SOP
      description: Create a new SOP (supervisor/admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - content
                - category
              properties:
                title:
                  type: string
                content:
                  type: string
                  description: Markdown content
                category:
                  type: string
                department:
                  type: string
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: SOP created
        '403':
          description: Insufficient permissions

  /api/production/sops/search:
    get:
      tags:
        - SOPs
      summary: Search SOPs
      description: Full-text search across SOPs
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/SOP'

  /api/production/sops/analytics:
    get:
      tags:
        - SOPs
      summary: Get SOP analytics
      description: Get usage analytics for SOPs
      responses:
        '200':
          description: SOP analytics
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          totalSOPs:
                            type: integer
                          mostViewed:
                            type: array
                            items:
                              type: object
                          byCategory:
                            type: object

  /api/production/sops/{id}:
    get:
      tags:
        - SOPs
      summary: Get SOP
      description: Get a specific SOP by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: SOP found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/SOP'
        '404':
          description: SOP not found

    patch:
      tags:
        - SOPs
      summary: Update SOP
      description: Update an existing SOP (supervisor/admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                content:
                  type: string
                category:
                  type: string
                department:
                  type: string
                tags:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
      responses:
        '200':
          description: SOP updated
        '403':
          description: Insufficient permissions

    delete:
      tags:
        - SOPs
      summary: Delete SOP
      description: Delete an SOP (admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: SOP deleted
        '403':
          description: Insufficient permissions

  /api/production/sops/{id}/versions:
    get:
      tags:
        - SOPs
      summary: Get SOP version history
      description: Get all versions of an SOP
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/RESTResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            version:
                              type: integer
                            createdAt:
                              type: string
                              format: date-time
                            createdBy:
                              type: string
                            changes:
                              type: string

  /api/production/sops/{id}/favorite:
    post:
      tags:
        - SOPs
      summary: Toggle SOP favorite
      description: Add or remove SOP from user's favorites
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Favorite toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  isFavorite:
                    type: boolean
