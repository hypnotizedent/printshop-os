services:
  postgres:
    image: postgres:15-alpine
    container_name: printshop-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-strapi}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secure_password_change_this}
      POSTGRES_DB: ${POSTGRES_DB:-printshop}
    volumes:
    - /mnt/docker/printshop-os/postgres:/var/lib/postgresql/data
    - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql:ro
    ports:
    - 5432:5432
    networks:
    - printshop_network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-strapi}
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: printshop-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
    - /mnt/docker/printshop-os/redis:/data
    ports:
    - 6379:6379
    networks:
    - printshop_network
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: printshop-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-secure_password_change_this}
    volumes:
    - /mnt/docker/printshop-os/minio:/data
    ports:
    - 9000:9000
    - 9001:9001
    networks:
    - printshop_network
    - tunnel_network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9000/minio/health/live
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mongo:
    image: mongo:6
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/data/mongo-keyfile"]
    container_name: printshop-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-secure_password_change_this}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-appsmith}
    volumes:
      - /mnt/docker/printshop-os/mongo:/data/db
      - ./mongo-keyfile:/data/mongo-keyfile:ro
    ports:
    - 27017:27017
    networks:
    - printshop_network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  strapi:
    build:
      context: ./printshop-strapi
      dockerfile: Dockerfile
    container_name: printshop-strapi
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      DATABASE_CLIENT: ${DATABASE_CLIENT:-postgres}
      DATABASE_HOST: postgres
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_NAME: ${DATABASE_NAME:-printshop}
      DATABASE_USERNAME: ${DATABASE_USERNAME:-strapi}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-secure_password_change_this}
      DATABASE_SSL: ${DATABASE_SSL:-false}
      JWT_SECRET: ${STRAPI_JWT_SECRET:-your-jwt-secret-change-this}
      ADMIN_JWT_SECRET: ${STRAPI_ADMIN_JWT_SECRET:-your-admin-jwt-secret-change-this}
      APP_KEYS: ${STRAPI_APP_KEYS:-your-app-key-1,your-app-key-2}
      API_TOKEN_SALT: ${STRAPI_API_TOKEN_SALT:-your-api-token-salt-change-this}
      PUBLIC_URL: ${STRAPI_PUBLIC_URL:-http://localhost:1337}
    volumes:
    - /mnt/docker/printshop-os/strapi/uploads:/srv/app/public/uploads
    ports:
    - 1337:1337
    networks:
    - printshop_network
    - tunnel_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - -O
      - /dev/null
      - http://localhost:1337
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: printshop-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      REDIS_URL: redis://redis:6379
      STRAPI_URL: http://strapi:1337
      DATABASE_HOST: postgres
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_NAME: ${DATABASE_NAME:-printshop}
      DATABASE_USERNAME: ${DATABASE_USERNAME:-strapi}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-secure_password_change_this}
      SS_ACTIVEWEAR_API_KEY: ${SS_ACTIVEWEAR_API_KEY:-}
      SS_ACTIVEWEAR_ACCOUNT_NUMBER: ${SS_ACTIVEWEAR_ACCOUNT_NUMBER:-}
      SANMAR_USERNAME: ${SANMAR_USERNAME:-}
      SANMAR_PASSWORD: ${SANMAR_PASSWORD:-}
      ASCOLOUR_API_KEY: ${ASCOLOUR_API_KEY:-}
    ports:
    - 3001:3001
    networks:
    - printshop_network
    - tunnel_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://127.0.0.1:3001/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  appsmith:
    image: appsmith/appsmith-ce:latest
    container_name: printshop-appsmith
    restart: unless-stopped
    environment:
      APPSMITH_INSTANCE_NAME: ${APPSMITH_INSTANCE_NAME:-PrintShop Production Dashboard}
      APPSMITH_ENCRYPTION_PASSWORD: ${APPSMITH_ENCRYPTION_PASSWORD:-your-encryption-password-change-this}
      APPSMITH_ENCRYPTION_SALT: ${APPSMITH_ENCRYPTION_SALT:-your-encryption-salt-change-this}
      APPSMITH_MONGODB_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME:-root}:${MONGO_INITDB_ROOT_PASSWORD:-secure_password_change_this}@mongo:27017/appsmith?authSource=admin
      APPSMITH_REDIS_URL: redis://redis:6379
      APPSMITH_MAIL_ENABLED: ${APPSMITH_MAIL_ENABLED:-false}
    volumes:
    - /mnt/docker/printshop-os/appsmith:/appsmith-stacks
    ports:
    - 8080:80
    - 8443:443
    networks:
    - printshop_network
    - tunnel_network
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      strapi:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://127.0.0.1:80
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  botpress:
    image: botpress/server:latest
    container_name: printshop-botpress
    restart: unless-stopped
    environment:
      BP_HOST: ${BOTPRESS_HOST:-0.0.0.0}
      BP_PORT: ${BOTPRESS_PORT:-3000}
      DATABASE_URL: postgres://${DATABASE_USERNAME:-strapi}:${DATABASE_PASSWORD:-secure_password_change_this}@postgres:5432/botpress
      BP_PRODUCTION: ${NODE_ENV:-development}
      EXTERNAL_URL: ${BOTPRESS_URL:-http://localhost:3100}
      BP_MODULE_NLU_LANGUAGESOURCES: '[{"endpoint":"https://lang-01.botpress.com"}]'
    volumes:
    - /mnt/docker/printshop-os/botpress:/botpress/data
    ports:
    - 3100:3000
    networks:
    - printshop_network
    - tunnel_network
    depends_on:
      postgres:
        condition: service_healthy
      strapi:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://127.0.0.1:3000/status
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  pricing-engine:
    build:
      context: ./services/job-estimator
      dockerfile: Dockerfile
    container_name: printshop-pricing-engine
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
    ports:
    - 3004:3001
    networks:
    - printshop_network
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://127.0.0.1:3001/health
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3001}
        VITE_STRAPI_URL: ${VITE_STRAPI_URL:-http://localhost:1337}
        VITE_PRICING_URL: ${VITE_PRICING_URL:-http://localhost:3004}
        VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:3004}
    container_name: printshop-frontend
    restart: unless-stopped
    ports:
    - 5173:3000
    networks:
    - printshop_network
    - tunnel_network
    depends_on:
    - strapi
    - pricing-engine
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://127.0.0.1:3000
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  printshop_network:
    driver: bridge
    name: printshop_network
    ipam:
      config:
        - subnet: 172.21.0.0/24

  tunnel_network:
    external: true
    name: tunnel_network

# =============================================================================
# STORAGE: All persistent data now on ZFS via NFS mount at /mnt/docker/
# Benefits: Compression, snapshots, checksums, 21TB capacity
# =============================================================================
